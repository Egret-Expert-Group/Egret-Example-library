var LoadingUI=function(t){function e(){t.call(this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.addToStageHandler,this)}__extends(e,t);var a=(__define,e),i=a.prototype;return i.addToStageHandler=function(t){this.textField=new egret.TextField,this.textField.y=.5*this.stage.stageHeight,this.textField.width=this.stage.stageWidth,this.textField.height=60,this.textField.textAlign="center",this.addChild(this.textField)},i.setProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e},e}(egret.Sprite);egret.registerClass(LoadingUI,"LoadingUI");var Main=function(t){function e(){t.call(this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStage,this)}__extends(e,t);var a=(__define,e),i=a.prototype;return i.onAddToStage=function(t){this.stage.dirtyRegionPolicy="off";var e=new egret.Shape;e.graphics.beginFill(3364215,.6),e.graphics.drawRect(0,0,this.stage.stageWidth,this.stage.stageHeight),e.$graphics.endFill(),e.cacheAsBitmap=!0,this.addChild(e),this.addChild(new coreElement.Game)},e}(egret.DisplayObjectContainer);egret.registerClass(Main,"Main");var BaseTest=function(t){function e(){t.call(this),this._resourceConfigURL=null,this.loadingView=null,this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStage,this)}__extends(e,t);var a=(__define,e),i=a.prototype;return i.onAddToStage=function(){if(!this._resourceConfigURL)throw new Error;this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this._onConfigComplete,this),RES.loadConfig(this._resourceConfigURL,"resource/")},i._onConfigComplete=function(t){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this._onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup("preload")},i.onResourceLoadComplete=function(t){"preload"==t.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.createGameScene())},i.onItemLoadError=function(t){console.warn("Url:"+t.resItem.url+" has failed to load")},i.onResourceLoadError=function(t){console.warn("Group:"+t.groupName+" has failed to load"),this.onResourceLoadComplete(t)},i.onResourceProgress=function(t){"preload"==t.groupName&&this.loadingView.setProgress(t.itemsLoaded,t.itemsTotal)},e}(egret.DisplayObjectContainer);egret.registerClass(BaseTest,"BaseTest");var coreElement;!function(t){var e=function(t){function e(){t.call(this),this.factory=new dragonBones.EgretFactory,this._left=!1,this._right=!1,this._player=null,this._bullets=[],e.instance=this,this._resourceConfigURL="resource/CoreElement.json"}__extends(e,t);var i=(__define,e),s=i.prototype;return s.createGameScene=function(){e.GROUND=this.stage.stageHeight-100,this.factory.parseDragonBonesData(RES.getRes("dragonBonesData")),this.factory.parseTextureAtlasData(RES.getRes("textureDataA"),RES.getRes("textureA")),this.stage.addEventListener(egret.Event.ENTER_FRAME,this._enterFrameHandler,this),this.stage.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this._touchHandler,this),this.stage.addEventListener(egret.TouchEvent.TOUCH_END,this._touchHandler,this),this.stage.addEventListener(egret.TouchEvent.TOUCH_CANCEL,this._touchHandler,this),this.stage.addEventListener(egret.TouchEvent.TOUCH_RELEASE_OUTSIDE,this._touchHandler,this),document.addEventListener("keydown",this._keyHandler),document.addEventListener("keyup",this._keyHandler);var t=egret.sys.TouchHandler.prototype.onTouchMove;egret.sys.TouchHandler.prototype.onTouchMove=function(a,i,s){t.call(this,a,i,s),e.instance._player.aim(a,i)},this._player=new a;var i=new egret.TextField;i.x=0,i.y=this.stage.stageHeight-60,i.width=this.stage.stageWidth,i.textAlign=egret.HorizontalAlign.CENTER,i.size=20,i.text="Press W/A/S/D to move. Press Q/E/SPACE to switch weapons.\nMouse Move to aim. Click to fire.",this.addChild(i)},s.addBullet=function(t){this._bullets.push(t)},s._touchHandler=function(t){this._player.aim(t.stageX,t.stageY),t.type==egret.TouchEvent.TOUCH_BEGIN?this._player.attack(!0):this._player.attack(!1)},s._keyHandler=function(t){var a="keydown"==t.type;switch(t.keyCode){case 37:case 65:e.instance._left=a,e.instance._updateMove(-1);break;case 39:case 68:e.instance._right=a,e.instance._updateMove(1);break;case 38:case 87:a&&e.instance._player.jump();break;case 83:case 40:e.instance._player.squat(a);break;case 81:a&&e.instance._player.switchWeaponR();break;case 69:a&&e.instance._player.switchWeaponL();break;case 32:a&&(e.instance._player.switchWeaponR(),e.instance._player.switchWeaponL())}},s._enterFrameHandler=function(t){this._player.update();for(var e=this._bullets.length;e--;){var a=this._bullets[e];a.update()&&this._bullets.splice(e,1)}dragonBones.WorldClock.clock.advanceTime(-1)},s._updateMove=function(t){this._left&&this._right?this._player.move(t):this._left?this._player.move(-1):this._right?this._player.move(1):this._player.move(0)},e.GROUND=300,e.G=.6,e.instance=null,e}(BaseTest);t.Game=e,egret.registerClass(e,"coreElement.Game");var a=function(){function t(){this._isJumpingA=!1,this._isJumpingB=!1,this._isSquating=!1,this._isAttackingA=!1,this._isAttackingB=!1,this._weaponRIndex=0,this._weaponLIndex=0,this._faceDir=1,this._aimDir=0,this._moveDir=0,this._aimRadian=0,this._speedX=0,this._speedY=0,this._armature=null,this._armatureDisplay=null,this._weaponR=null,this._weaponL=null,this._aimState=null,this._walkState=null,this._attackState=null,this._target=new egret.Point,this._armature=e.instance.factory.buildArmature("mecha_1502b"),this._armatureDisplay=this._armature.display,this._armatureDisplay.x=.5*e.instance.stage.stageWidth,this._armatureDisplay.y=e.GROUND,this._armatureDisplay.scaleX=this._armatureDisplay.scaleY=1,this._armatureDisplay.addEventListener(dragonBones.EventObject.FADE_IN_COMPLETE,this._animationEventHandler,this),this._armatureDisplay.addEventListener(dragonBones.EventObject.FADE_OUT_COMPLETE,this._animationEventHandler,this),this._armature.getSlot("effects_1").displayController=t.NORMAL_ANIMATION_GROUP,this._armature.getSlot("effects_2").displayController=t.NORMAL_ANIMATION_GROUP,this._weaponR=this._armature.getSlot("weapon_r").childArmature,this._weaponL=this._armature.getSlot("weapon_l").childArmature,this._weaponR.addEventListener(dragonBones.EventObject.FRAME_EVENT,this._frameEventHandler,this),this._weaponL.addEventListener(dragonBones.EventObject.FRAME_EVENT,this._frameEventHandler,this),this._updateAnimation(),e.instance.addChild(this._armatureDisplay),dragonBones.WorldClock.clock.add(this._armature)}var a=(__define,t),s=a.prototype;return s.move=function(t){this._moveDir!=t&&(this._moveDir=t,this._updateAnimation())},s.jump=function(){this._isJumpingA||(this._isJumpingA=!0,this._armature.animation.fadeIn("jump_1",-1,-1,0,t.NORMAL_ANIMATION_GROUP),this._walkState=null)},s.squat=function(t){this._isSquating!=t&&(this._isSquating=t,this._updateAnimation())},s.attack=function(t){this._isAttackingA!=t&&(this._isAttackingA=t)},s.switchWeaponR=function(){this._weaponRIndex++,this._weaponRIndex>=t.WEAPON_R_LIST.length&&(this._weaponRIndex=0),this._weaponR.removeEventListener(dragonBones.EventObject.FRAME_EVENT,this._frameEventHandler,this);var a=t.WEAPON_R_LIST[this._weaponRIndex];this._weaponR=e.instance.factory.buildArmature(a),this._armature.getSlot("weapon_r").childArmature=this._weaponR,this._weaponR.addEventListener(dragonBones.EventObject.FRAME_EVENT,this._frameEventHandler,this)},s.switchWeaponL=function(){this._weaponLIndex++,this._weaponLIndex>=t.WEAPON_L_LIST.length&&(this._weaponLIndex=0),this._weaponL.removeEventListener(dragonBones.EventObject.FRAME_EVENT,this._frameEventHandler,this);var a=t.WEAPON_L_LIST[this._weaponLIndex];this._weaponL=e.instance.factory.buildArmature(a),this._armature.getSlot("weapon_l").childArmature=this._weaponL,this._weaponL.addEventListener(dragonBones.EventObject.FRAME_EVENT,this._frameEventHandler,this)},s.aim=function(t,e){0==this._aimDir&&(this._aimDir=10),this._target.setTo(t,e)},s.update=function(){this._updatePosition(),this._updateAim(),this._updateAttack()},s._animationEventHandler=function(e){switch(e.type){case dragonBones.EventObject.FADE_IN_COMPLETE:"jump_1"==e.eventObject.animationState.name?(this._isJumpingB=!0,this._speedY=-t.JUMP_SPEED,this._armature.animation.fadeIn("jump_2",-1,-1,0,t.NORMAL_ANIMATION_GROUP)):"jump_4"==e.eventObject.animationState.name&&this._updateAnimation();break;case dragonBones.EventObject.FADE_OUT_COMPLETE:"attack_01"==e.eventObject.animationState.name&&(this._isAttackingB=!1,this._attackState=null)}},s._frameEventHandler=function(e){if("onFire"==e.eventObject.name){var a=e.eventObject.armature.getBone("firePoint");e.eventObject.armature.display.localToGlobal(a.global.x,a.global.y,t._globalPoint),this._fire(t._globalPoint)}},s._fire=function(t){t.x+=2*Math.random()-1,t.y+=2*Math.random()-1;var a=this._faceDir<0?Math.PI-this._aimRadian:this._aimRadian,s=new i("bullet_01","fireEffect_01",a+.02*Math.random()-.01,40,t);e.instance.addBullet(s)},s._updateAnimation=function(){return this._isJumpingA?void 0:this._isSquating?(this._speedX=0,this._armature.animation.fadeIn("squat",-1,-1,0,t.NORMAL_ANIMATION_GROUP),void(this._walkState=null)):void(0==this._moveDir?(this._speedX=0,this._armature.animation.fadeIn("idle",-1,-1,0,t.NORMAL_ANIMATION_GROUP),this._walkState=null):(this._walkState||(this._walkState=this._armature.animation.fadeIn("walk",-1,-1,0,t.NORMAL_ANIMATION_GROUP)),this._moveDir*this._faceDir>0?this._walkState.timeScale=t.MAX_MOVE_SPEED_FRONT/t.NORMALIZE_MOVE_SPEED:this._walkState.timeScale=-t.MAX_MOVE_SPEED_BACK/t.NORMALIZE_MOVE_SPEED,this._moveDir*this._faceDir>0?this._speedX=t.MAX_MOVE_SPEED_FRONT*this._faceDir:this._speedX=-t.MAX_MOVE_SPEED_BACK*this._faceDir))},s._updatePosition=function(){0!=this._speedX&&(this._armatureDisplay.x+=this._speedX,this._armatureDisplay.x<0?this._armatureDisplay.x=0:this._armatureDisplay.x>e.instance.stage.stageWidth&&(this._armatureDisplay.x=e.instance.stage.stageWidth)),0!=this._speedY&&(this._speedY<5&&this._speedY+e.G>=5&&this._armature.animation.fadeIn("jump_3",-1,-1,0,t.NORMAL_ANIMATION_GROUP),this._speedY+=e.G,this._armatureDisplay.y+=this._speedY,this._armatureDisplay.y>e.GROUND&&(this._armatureDisplay.y=e.GROUND,this._isJumpingA=!1,this._isJumpingB=!1,this._speedY=0,this._speedX=0,this._armature.animation.fadeIn("jump_4",-1,-1,0,t.NORMAL_ANIMATION_GROUP),(this._isSquating||this._moveDir)&&this._updateAnimation()))},s._updateAim=function(){if(0!=this._aimDir){this._faceDir=this._target.x>this._armatureDisplay.x?1:-1,this._armatureDisplay.scaleX*this._faceDir<0&&(this._armatureDisplay.scaleX*=-1,this._moveDir&&this._updateAnimation());var e=this._armature.getBone("chest").global.y*this._armatureDisplay.scaleY;this._faceDir>0?this._aimRadian=Math.atan2(this._target.y-this._armatureDisplay.y-e,this._target.x-this._armatureDisplay.x):(this._aimRadian=Math.PI-Math.atan2(this._target.y-this._armatureDisplay.y-e,this._target.x-this._armatureDisplay.x),this._aimRadian>Math.PI&&(this._aimRadian-=2*Math.PI));var a=0;a=this._aimRadian>0?-1:1,this._aimDir!=a&&(this._aimDir=a,this._aimDir>=0?this._aimState=this._armature.animation.fadeIn("aimUp",0,1,0,t.AIM_ANIMATION_GROUP,2):this._aimState=this._armature.animation.fadeIn("aimDown",0,1,0,t.AIM_ANIMATION_GROUP,2)),this._aimState.weight=Math.abs(this._aimRadian/Math.PI*2),this._armature.invalidUpdate()}},s._updateAttack=function(){this._isAttackingA&&!this._isAttackingB&&(this._isAttackingB=!0,this._attackState=this._armature.animation.fadeIn("attack_01",-1,-1,0,t.ATTACK_ANIMATION_GROUP,2),this._attackState.autoFadeOutTime=this._attackState.fadeTotalTime,this._attackState.addBoneMask("pelvis"))},t.NORMAL_ANIMATION_GROUP="normal",t.AIM_ANIMATION_GROUP="aim",t.ATTACK_ANIMATION_GROUP="attack",t.JUMP_SPEED=20,t.NORMALIZE_MOVE_SPEED=3.6,t.MAX_MOVE_SPEED_FRONT=1.4*t.NORMALIZE_MOVE_SPEED,t.MAX_MOVE_SPEED_BACK=1*t.NORMALIZE_MOVE_SPEED,t.WEAPON_R_LIST=["weapon_1502b_r","weapon_1005","weapon_1005b","weapon_1005c","weapon_1005d","weapon_1005e"],t.WEAPON_L_LIST=["weapon_1502b_l","weapon_1005","weapon_1005b","weapon_1005c","weapon_1005d"],t._globalPoint=new egret.Point,t}();egret.registerClass(a,"Mecha");var i=function(){function t(t,a,i,s,n){if(this._speedX=0,this._speedY=0,this._armature=null,this._armatureDisplay=null,this._effect=null,this._speedX=Math.cos(i)*s,this._speedY=Math.sin(i)*s,this._armature=e.instance.factory.buildArmature(t),this._armatureDisplay=this._armature.display,this._armatureDisplay.x=n.x,this._armatureDisplay.y=n.y,this._armatureDisplay.rotation=i*dragonBones.DragonBones.RADIAN_TO_ANGLE,this._armature.animation.play("idle"),a){this._effect=e.instance.factory.buildArmature(a);var r=this._effect.display;r.rotation=i*dragonBones.DragonBones.RADIAN_TO_ANGLE,r.x=n.x,r.y=n.y,r.scaleX=1+1*Math.random(),r.scaleY=1+.5*Math.random(),Math.random()<.5&&(r.scaleY*=-1),this._effect.animation.play("idle"),dragonBones.WorldClock.clock.add(this._effect),e.instance.addChild(r)}dragonBones.WorldClock.clock.add(this._armature),e.instance.addChild(this._armatureDisplay)}var a=(__define,t),i=a.prototype;return i.update=function(){return this._armatureDisplay.x+=this._speedX,this._armatureDisplay.y+=this._speedY,this._armatureDisplay.x<-100||this._armatureDisplay.x>=e.instance.stage.stageWidth+100||this._armatureDisplay.y<-100||this._armatureDisplay.y>=e.instance.stage.stageHeight+100?(dragonBones.WorldClock.clock.remove(this._armature),e.instance.removeChild(this._armatureDisplay),this._armature.dispose(),this._effect&&(dragonBones.WorldClock.clock.remove(this._effect),e.instance.removeChild(this._effect.display),this._effect.dispose()),!0):!1},t}();egret.registerClass(i,"Bullet")}(coreElement||(coreElement={}));